
# Apache 日誌進階分析器

本專案是一個針對 Apache 日誌的深入分析工具。藉由檢索增強生成（RAG）流程配合本地部署的 Llama3，能在不依賴外部雲端服務的情況下辨識各類攻擊行為。程式會增量讀取 `.log`、`.gz` 或 `.bz2` 檔案，先以啟發式規則選出高風險請求，再對其進行向量化與語意比對，若發現相似紀錄則直接套用舊有結論，否則再呼叫 Llama3 產生結構化的 JSON 報告。

```mermaid
graph TD
    A[Apache 日誌] --> B[預處理與啟發式評分]
    B --> C{高風險?}
    C -->|否| D[標記為正常]
    C -->|是| E[向量化]
    E --> F[Faiss 相似度檢索]
    F --> G[Ollama/Llama3 深度分析]
    G --> H[輸出 JSON]
```

## 技術特色
- **增量讀取**：紀錄 inode 與 offset，只處理新產生的行
- **啟發式篩選**：依規則挑出可能的攻擊請求
- **向量資料庫**：使用 FAISS 儲存並比對相似攻擊模式
- **本地 LLM 分析**：透過 Docker 執行的 Ollama 呼叫 Llama3
- **成本控制**：可設定每小時的 LLM 使用費用上限

## 系統流程
1. 從指定目錄擷取最新日誌並記錄狀態，避免重複分析。
2. 先以啟發式規則判斷是否為可疑請求。
3. 高風險項目會計算文字向量並在 FAISS 中尋找相似紀錄。
4. 若命中舊資料則直接輸出結論，否則將該批送交 Llama3 分析。
5. LLM 回傳的 JSON 包含攻擊類型、成因與嚴重度，可即時整合到監控系統。
6. 所有索引與狀態皆儲存在 `data/` 目錄，方便持續累積與追蹤。

## 安裝與執行
1. 安裝 [Poetry](https://python-poetry.org/docs/#installation) 後執行 `poetry install`
2. 將 `.env.example` 複製為 `.env`，依需要調整 `OLLAMA_API_URL` 等參數
3. 透過 `poetry run python run.py` 開始分析

此工具適合於公司內網或斷網環境長期監控 Apache 伺服器，也能依需求擴充判斷規則與模型，使防禦機制更貼近實際攻擊手法。
=======
# 進階日誌分析器 (RAG 版本)

這是一個使用檢索增強生成 (RAG) 技術，結合大型語言模型 (LLM) 來自動分析 Web 伺服器日誌的專案。

## 功能

- **增量讀取**: 只處理上次執行後新增的日誌內容。
- **快速篩選**: 使用啟發式規則快速評分，篩選出可疑日誌。
- **向量檢索**: 將可疑日誌轉換為向量並存入 FAISS，用於尋找相似的攻擊模式。
- **LLM 深度分析**: 將高風險日誌發送給本機的 Llama3（透過 Ollama）進行深度分析，判斷攻擊類型和嚴重性。
- **成本控制**: 內建快取、批次處理和每小時費用上限，防止意外的高昂費用。
- **結構化輸出**: 將分析結果匯出為 JSON 格式，方便後續處理。

## 安裝

1.  安裝 [Poetry](https://python-poetry.org/docs/#installation)。
2.  安裝專案依賴:
    ```bash
    poetry install
    ```

## 設定

1.  複製環境變數模板檔案:
    ```bash
    cp .env.example .env
    ```
2.  編輯 `.env` 檔案，視需要設定 `OLLAMA_API_URL`（預設為 `http://localhost:11434/api/generate`）。
3.  根據需求修改其他路徑或參數設定。

## 如何執行

直接執行 `run.py` 腳本:

```bash
poetry run python run.py
```

